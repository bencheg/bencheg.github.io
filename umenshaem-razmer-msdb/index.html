<!DOCTYPE html>
<html lang="ru"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="–ü—Ä–∏–≤–µ—Ç! üëã –ó–¥–µ—Å—å —è –ø—É–±–ª–∏–∫—É—é –∑–∞–º–µ—Ç–∫–∏ –æ —Ä–∞–∑–Ω—ã—Ö IT —à—Ç—É–∫–∞—Ö –∏ –Ω–µ —Ç–æ–ª—å–∫–æ. –¢–æ, —á—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ –º–Ω–µ –∏ —á–µ–º —Ö–æ—á–µ—Ç—Å—è –ø–æ–¥–µ–ª–∏—Ç—å—Å—è.">
    

    
    <link rel="shortcut icon" type="image/x-icon" href="https://marand.ru/images/favicon.jpg" />
    
    <link rel="stylesheet" href="/css/style.min.css">

    <link rel="canonical" href="https://marand.ru/umenshaem-razmer-msdb/" />
    <title>–£–º–µ–Ω—å—à–∞–µ–º —Ä–∞–∑–º–µ—Ä MSDB</title>
</head>
<body><header id="banner">
    <h2><a href="https://marand.ru">marand.ru</a></h2>
    <nav>
        <ul>
            <li>
                <a href="/" title="–ü–æ—Å—Ç—ã">–ü–æ—Å—Ç—ã</a>
            </li>
        </ul>
    </nav>
</header>
<main id="content">
<article>
    <header id="post-header">
        <h1>–£–º–µ–Ω—å—à–∞–µ–º —Ä–∞–∑–º–µ—Ä MSDB</h1>
        <div>
                <time>10 –º–∞—Ä—Ç–∞ 2023</time>
            <a href='/tags/mssql'>mssql</a></div>
    </header><p>–†–∞–∑–º–µ—Ä —Å–∏—Å—Ç–µ–º–Ω–æ–π –±–∞–∑—ã msdb —Å—Ç–∞–ª –±–æ–ª—å—à–µ 11 –≥–±, –Ω–∞—Å—Ç–∞–ª–æ –≤—Ä–µ–º—è –µ–µ –ø–æ—á–∏—Å—Ç–∏—Ç—å.</p>
<p>–î–ª—è –Ω–∞—á–∞–ª–∞, –ø–æ—Å–º–æ—Ç—Ä–∏–º –∫–∞–∫–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Å–∫–æ–ª—å–∫–æ –º–µ—Å—Ç–∞ –∑–∞–Ω–∏–º–∞–µ—Ç:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">USE</span><span class="w"> </span><span class="n">MSDB</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">select</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">TableName</span><span class="p">,</span><span class="k">Min</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">create_date</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">CreateDate</span><span class="p">,</span><span class="n">ds</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">FileGroupName</span><span class="p">,</span><span class="w"> </span><span class="k">SUM</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">total_pages</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="o">/</span><span class="mi">1024</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">SizeMB</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">from</span><span class="w"> </span><span class="n">sys</span><span class="p">.</span><span class="n">tables</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">t</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">sys</span><span class="p">.</span><span class="n">partitions</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">object_id</span><span class="o">=</span><span class="n">p</span><span class="p">.</span><span class="n">object_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">sys</span><span class="p">.</span><span class="n">allocation_units</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">partition_id</span><span class="o">=</span><span class="n">u</span><span class="p">.</span><span class="n">container_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">inner</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">sys</span><span class="p">.</span><span class="n">data_spaces</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">ds</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">u</span><span class="p">.</span><span class="n">data_space_id</span><span class="o">=</span><span class="n">ds</span><span class="p">.</span><span class="n">data_space_id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">ds</span><span class="p">.</span><span class="n">name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">sizemb</span><span class="w"> </span><span class="k">desc</span></span></span></code></pre></div>
<p>–í –º–æ–µ–º —Å–ª—É—á–∞–µ —ç—Ç–æ –±—ã–ª–∞ —Ç–∞–±–ª–∏—Ü–∞ sysmaintplan_logdetail. –û–∫–æ–ª–æ 10 –≥–±.</p>
<p>–ß–∏—Å—Ç–∏–º:
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">USE</span><span class="w"> </span><span class="n">MSDB</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">sysmaintplan_log</span><span class="p">]</span><span class="w"> </span><span class="k">DROP</span><span class="w"> </span><span class="k">CONSTRAINT</span><span class="w"> </span><span class="p">[</span><span class="n">FK_sysmaintplan_log_subplan_id</span><span class="p">];</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">sysmaintplan_logdetail</span><span class="p">]</span><span class="w"> </span><span class="k">DROP</span><span class="w"> </span><span class="k">CONSTRAINT</span><span class="w"> </span><span class="p">[</span><span class="n">FK_sysmaintplan_log_detail_task_id</span><span class="p">];</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">truncate</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">msdb</span><span class="p">.</span><span class="n">dbo</span><span class="p">.</span><span class="n">sysmaintplan_logdetail</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">truncate</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">msdb</span><span class="p">.</span><span class="n">dbo</span><span class="p">.</span><span class="n">sysmaintplan_log</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">sysmaintplan_log</span><span class="p">]</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="k">CHECK</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="k">CONSTRAINT</span><span class="w"> </span><span class="p">[</span><span class="n">FK_sysmaintplan_log_subplan_id</span><span class="p">]</span><span class="w"> </span><span class="k">FOREIGN</span><span class="w"> </span><span class="k">KEY</span><span class="p">([</span><span class="n">subplan_id</span><span class="p">])</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">REFERENCES</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">sysmaintplan_subplans</span><span class="p">]</span><span class="w"> </span><span class="p">([</span><span class="n">subplan_id</span><span class="p">]);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">sysmaintplan_logdetail</span><span class="p">]</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="k">CHECK</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="k">CONSTRAINT</span><span class="w"> </span><span class="p">[</span><span class="n">FK_sysmaintplan_log_detail_task_id</span><span class="p">]</span><span class="w"> </span><span class="k">FOREIGN</span><span class="w"> </span><span class="k">KEY</span><span class="p">([</span><span class="n">task_detail_id</span><span class="p">])</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">REFERENCES</span><span class="w"> </span><span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">sysmaintplan_log</span><span class="p">]</span><span class="w"> </span><span class="p">([</span><span class="n">task_detail_id</span><span class="p">])</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">CASCADE</span><span class="p">;</span></span></span></code></pre></div></p>
<p>–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–∂–∏–º–∞–µ–º –±–∞–∑—É:
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">DBCC</span><span class="w"> </span><span class="n">SHRINKFILE</span><span class="w"> </span><span class="p">(</span><span class="n">MSDBData</span><span class="p">,</span><span class="w"> </span><span class="mi">512</span><span class="p">)</span></span></span></code></pre></div></p>
<p>–ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="k">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">size</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">8</span><span class="p">.</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1024</span><span class="p">,</span><span class="w"> </span><span class="n">space_used</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FILEPROPERTY</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;SpaceUsed&#39;</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">8</span><span class="p">.</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">1024</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">sys</span><span class="p">.</span><span class="n">database_files</span></span></span></code></pre></div></p>
<p>–ò –¥–æ–±–∞–≤–∏—Ç—å –µ—â–µ –æ—á–∏—Å—Ç–∫—É –ª–æ–≥–æ–≤ –¥–∂–æ–±–æ–≤ –∏ –±–µ–∫–∞–ø–æ–≤:
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">DateBefore</span><span class="w"> </span><span class="n">DATETIME</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">DateBefore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DATEADD</span><span class="p">(</span><span class="k">DAY</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="n">GETDATE</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">EXEC</span><span class="w"> </span><span class="n">msdb</span><span class="p">.</span><span class="n">dbo</span><span class="p">.</span><span class="n">sp_purge_jobhistory</span><span class="w"> </span><span class="o">@</span><span class="n">oldest_date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">DateBefore</span></span></span></code></pre></div>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">DateBefore</span><span class="w"> </span><span class="n">DATETIME</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">DateBefore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DATEADD</span><span class="p">(</span><span class="k">DAY</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">60</span><span class="p">,</span><span class="w"> </span><span class="n">GETDATE</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">EXEC</span><span class="w"> </span><span class="n">msdb</span><span class="p">.</span><span class="n">dbo</span><span class="p">.</span><span class="n">sp_delete_backuphistory</span><span class="w"> </span><span class="o">@</span><span class="n">oldest_date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">DateBefore</span></span></span></code></pre></div></p>
</article>

        </main><footer id="footer">
    
</footer>


<script type="text/javascript" >
    (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
    m[i].l=1*new Date();
    for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
    k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
    (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");
 
    ym(92841410, "init", {
         clickmap:true,
         trackLinks:true,
         accurateTrackBounce:true
    });
 </script>
 <noscript><div><img src="https://mc.yandex.ru/watch/92841410" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
 
</body>
</html>
